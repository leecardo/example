version: '3.8'

services:
  # Java Spring Boot Application
  java-app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        MVN_PROFILE: dev
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker,dev
      - DB_HOST=mariadb
      - DB_PORT=3306
      - DB_NAME=test
      - DB_USER=root
      - DB_PASSWORD=root123
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - CHROMADB_HOST=chromadb
      - CHROMADB_PORT=8000
      - JAVA_OPTS=-XX:+UseG1GC -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -Xdebug -Xrunjdwp:transport=dt_socket,address=*:5005,server=y,suspend=n
    depends_on:
      - mariadb
      - redis
      - chromadb
    networks:
      - dev-network
    restart: unless-stopped
    volumes:
      - ./cloud-service:/app  # 开发时挂载Java源码
      - java_dev_logs:/app/logs

  # Python AI Service
  ai-service:
    build:
      context: ./ai-service
      dockerfile: Dockerfile
    ports:
      - "8081:8081"
      - "5006:5006"  # Python debugger port
    environment:
      - HOST=0.0.0.0
      - PORT=8081
      - DB_HOST=mariadb
      - DB_PORT=3306
      - DB_NAME=test
      - DB_USER=root
      - DB_PASSWORD=root123
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - CHROMADB_HOST=chromadb
      - CHROMADB_PORT=8000
      - EMBEDDING_MODEL=sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2
      - NLP_MODEL=facebook/bart-large-cnn
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - LOG_FORMAT=console
      - MAX_FILE_SIZE=50MB
    depends_on:
      - mariadb
      - redis
      - chromadb
    networks:
      - dev-network
    restart: unless-stopped
    volumes:
      - ./ai-service:/app  # 开发时挂载Python源码
      - ai_dev_uploads:/app/temp_uploads
      - ai_dev_logs:/app/logs
      - ai_dev_models_cache:/root/.cache
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8081", "--reload", "--log-level", "debug"]

  # MariaDB Database
  mariadb:
    image: mariadb:10.11
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: test
    ports:
      - "3306:3306"
    volumes:
      - mariadb_dev_data:/var/lib/mysql
    networks:
      - dev-network
    restart: unless-stopped

  # Redis Cache
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_dev_data:/data
    networks:
      - dev-network
    restart: unless-stopped

  # ChromaDB Vector Database
  chromadb:
    image: chromadb/chroma:latest
    ports:
      - "8000:8000"
    volumes:
      - chromadb_dev_data:/chroma/chroma
    networks:
      - dev-network
    restart: unless-stopped

networks:
  dev-network:
    driver: bridge

volumes:
  mariadb_dev_data:
  redis_dev_data:
  chromadb_dev_data:
  ai_dev_uploads:
  ai_dev_logs:
  ai_dev_models_cache:
  java_dev_logs: